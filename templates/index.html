<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åŠ å¯†ä¸å¯†ç ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        h2 {
            color: #34495e;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .password-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
        }
        
        .password-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .password-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .password-item.selected {
            background: #d4e3fc;
            border-left: 4px solid #667eea;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .file-input-label:hover {
            background: #5568d3;
        }
        
        .filename-display {
            display: inline-block;
            margin-left: 15px;
            color: #34495e;
            font-weight: 500;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .info-box li {
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¦–æ¬¡è®¾ç½®ç•Œé¢ -->
        <div id="setup-screen" class="card {% if not first_time or logged_in %}hidden{% endif %}">
            <h1>ğŸ” æ¬¢è¿ä½¿ç”¨æ•°æ®åŠ å¯†ä¸å¯†ç ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="subtitle">é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®ä¸»å¯†ç </p>
            
            <div class="info-box">
                <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>
                <ul>
                    <li>ä¸»å¯†ç å°†ç”¨äºä¿æŠ¤æ‰€æœ‰æ•°æ®ï¼Œè¯·å¦¥å–„ä¿ç®¡</li>
                    <li>å»ºè®®ï¼šè‡³å°‘12ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç¬¦å·</li>
                    <li>é—å¤±ä¸»å¯†ç å°†æ— æ³•æ¢å¤æ•°æ®</li>
                </ul>
            </div>
            
            <div id="setup-alert"></div>
            
            <form id="setup-form" onsubmit="return false;">
                <div class="form-group">
                    <label>è®¾ç½®ä¸»å¯†ç </label>
                    <input type="password" id="setup-password1" required>
                </div>
                
                <div class="form-group">
                    <label>ç¡®è®¤ä¸»å¯†ç </label>
                    <input type="password" id="setup-password2" required>
                </div>
                
                <button type="submit" class="btn btn-primary" onclick="setupMasterPassword()">ç¡®è®¤è®¾ç½®</button>
            </form>
        </div>
        
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="login-screen" class="card {% if first_time or logged_in %}hidden{% endif %}">
            <h1>ğŸ” æ•°æ®åŠ å¯†ä¸å¯†ç ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="subtitle">è¯·è¾“å…¥ä¸»å¯†ç ç™»å½•</p>
            
            <div id="login-alert"></div>
            
            <form id="login-form" onsubmit="return false;">
                <div class="form-group">
                    <label>ä¸»å¯†ç </label>
                    <input type="password" id="login-password" required autofocus>
                </div>
                
                <button type="submit" class="btn btn-primary" onclick="login()">ç™»å½•</button>
            </form>
        </div>
        
        <!-- ä¸»ç•Œé¢ -->
        <div id="main-screen" class="{% if not logged_in %}hidden{% endif %}">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>ğŸ” æ•°æ®åŠ å¯†ä¸å¯†ç ç®¡ç†ç³»ç»Ÿ</h1>
                    <button class="btn btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
            
            <div class="card">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('passwords')">å¯†ç ç®¡ç†</button>
                    <button class="tab" onclick="showTab('file-encrypt')">æ–‡ä»¶åŠ å¯†</button>
                    <button class="tab" onclick="showTab('text-encrypt')">æ–‡æœ¬åŠ å¯†</button>
                    <button class="tab" onclick="showTab('settings')">è®¾ç½®</button>
                </div>
                
                <!-- å¯†ç ç®¡ç†æ ‡ç­¾é¡µ -->
                <div id="passwords-tab" class="tab-content active">
                    <div id="password-alert"></div>
                    
                    <div class="grid-2">
                        <!-- å·¦ä¾§ï¼šå¯†ç åˆ—è¡¨ -->
                        <div>
                            <h2>å·²ä¿å­˜çš„å¯†ç </h2>
                            <div id="password-list" class="password-list">
                                <div class="loading">åŠ è½½ä¸­...</div>
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-primary" onclick="viewPassword()">æŸ¥çœ‹å¯†ç </button>
                                <button class="btn btn-success" onclick="copyPassword()">å¤åˆ¶å¯†ç </button>
                                <button class="btn btn-danger" onclick="deletePassword()">åˆ é™¤å¯†ç </button>
                                <button class="btn btn-secondary" onclick="loadPasswords()">åˆ·æ–°åˆ—è¡¨</button>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šæ·»åŠ æ–°å¯†ç  -->
                        <div>
                            <h2>æ·»åŠ æ–°å¯†ç </h2>
                            <form id="add-password-form" onsubmit="return false;">
                                <div class="form-group">
                                    <label>ç½‘ç«™/æœåŠ¡åç§°</label>
                                    <input type="text" id="password-site" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>ç”¨æˆ·å</label>
                                    <input type="text" id="password-username">
                                </div>
                                
                                <div class="form-group">
                                    <label>å¯†ç </label>
                                    <input type="text" id="password-value" required>
                                </div>
                                
                                <div class="form-group">
                                    <button type="button" class="btn btn-secondary" onclick="generatePassword()">ç”Ÿæˆå¼ºå¯†ç </button>
                                    <label style="display: inline; margin-left: 10px;">é•¿åº¦:</label>
                                    <input type="number" id="password-length" value="16" min="8" max="32" style="width: 80px; display: inline-block; margin-left: 5px;">
                                </div>
                                
                                <div class="form-group">
                                    <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                                    <textarea id="password-notes"></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-primary" onclick="addPassword()">ä¿å­˜å¯†ç </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- æ–‡ä»¶åŠ å¯†æ ‡ç­¾é¡µ -->
                <div id="file-encrypt-tab" class="tab-content">
                    <div id="file-alert"></div>
                    
                    <!-- æ–¹å¼é€‰æ‹© -->
                    <div style="margin-bottom: 30px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">é€‰æ‹©åŠ å¯†æ–¹å¼ï¼š</label>
                        <div>
                            <input type="radio" id="mode-upload" name="encrypt-mode" value="upload" checked onchange="toggleEncryptMode()">
                            <label for="mode-upload" style="display: inline; margin-right: 20px; cursor: pointer;">ä¸Šä¼ æ–‡ä»¶ï¼ˆä¸‹è½½åŠ å¯†ç»“æœï¼‰</label>
                            
                            <input type="radio" id="mode-local" name="encrypt-mode" value="local" onchange="toggleEncryptMode()">
                            <label for="mode-local" style="display: inline; cursor: pointer;">æœ¬åœ°è·¯å¾„ï¼ˆåŠ å¯†åˆ°åŒä¸€ç›®å½•ï¼‰</label>
                        </div>
                    </div>
                    
                    <!-- ä¸Šä¼ æ¨¡å¼ -->
                    <div id="upload-mode-section">
                        <h2>ğŸ“ åŠ å¯†æ–‡ä»¶ï¼ˆä¸Šä¼ æ¨¡å¼ï¼‰</h2>
                        <div class="info-box" style="font-size: 12px; margin-bottom: 15px;">
                            ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨åŠ å¯†ï¼Œå®Œæˆåè‡ªåŠ¨ä¸‹è½½åŠ å¯†æ–‡ä»¶
                        </div>
                        <div class="form-group">
                            <label>é€‰æ‹©è¦åŠ å¯†çš„æ–‡ä»¶</label>
                            <div class="file-input-wrapper">
                                <label class="file-input-label" for="encrypt-file-input">ğŸ“‚ é€‰æ‹©æ–‡ä»¶</label>
                                <input type="file" id="encrypt-file-input" onchange="displayFilename('encrypt')">
                                <span id="encrypt-filename" class="filename-display">æœªé€‰æ‹©æ–‡ä»¶</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="encryptFile()">ğŸ”’ ä¸Šä¼ å¹¶åŠ å¯†</button>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                        
                        <h2>ğŸ”“ è§£å¯†æ–‡ä»¶ï¼ˆä¸Šä¼ æ¨¡å¼ï¼‰</h2>
                        <div class="info-box" style="font-size: 12px; margin-bottom: 15px;">
                            ä¸Šä¼ åŠ å¯†æ–‡ä»¶åˆ°æœåŠ¡å™¨è§£å¯†ï¼Œå®Œæˆåè‡ªåŠ¨ä¸‹è½½åŸå§‹æ–‡ä»¶
                        </div>
                        <div class="form-group">
                            <label>é€‰æ‹©è¦è§£å¯†çš„æ–‡ä»¶</label>
                            <div class="file-input-wrapper">
                                <label class="file-input-label" for="decrypt-file-input">ğŸ“‚ é€‰æ‹©æ–‡ä»¶</label>
                                <input type="file" id="decrypt-file-input" onchange="displayFilename('decrypt')">
                                <span id="decrypt-filename" class="filename-display">æœªé€‰æ‹©æ–‡ä»¶</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="decryptFile()">ğŸ”“ ä¸Šä¼ å¹¶è§£å¯†</button>
                    </div>
                    
                    <!-- æœ¬åœ°è·¯å¾„æ¨¡å¼ -->
                    <div id="local-mode-section" class="hidden">
                        <h2>ğŸ“ åŠ å¯†æœ¬åœ°æ–‡ä»¶</h2>
                        <div class="info-box" style="font-size: 12px; margin-bottom: 15px;">
                            ç›´æ¥åŠ å¯†æœ¬åœ°æ–‡ä»¶ï¼Œç»“æœä¿å­˜åœ¨åŒä¸€ç›®å½•ä¸‹ï¼ˆæ–‡ä»¶åæ·»åŠ  .encryptedï¼‰
                        </div>
                        <div class="form-group">
                            <label>æ–‡ä»¶è·¯å¾„ï¼ˆæ”¯æŒ ~ è¡¨ç¤ºç”¨æˆ·ç›®å½•ï¼‰</label>
                            <input type="text" id="encrypt-local-path" placeholder="ä¾‹å¦‚: ~/Documents/secret.txt æˆ– /Users/username/file.pdf">
                        </div>
                        <button class="btn btn-primary" onclick="encryptFileLocal()">ğŸ”’ åŠ å¯†æ–‡ä»¶</button>
                        
                        <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                        
                        <h2>ğŸ”“ è§£å¯†æœ¬åœ°æ–‡ä»¶</h2>
                        <div class="info-box" style="font-size: 12px; margin-bottom: 15px;">
                            ç›´æ¥è§£å¯†æœ¬åœ°æ–‡ä»¶ï¼Œç»“æœä¿å­˜åœ¨åŒä¸€ç›®å½•ä¸‹ï¼ˆè‡ªåŠ¨ç§»é™¤ .encrypted æ‰©å±•åï¼‰
                        </div>
                        <div class="form-group">
                            <label>æ–‡ä»¶è·¯å¾„</label>
                            <input type="text" id="decrypt-local-path" placeholder="ä¾‹å¦‚: ~/Documents/secret.txt.encrypted">
                        </div>
                        <button class="btn btn-primary" onclick="decryptFileLocal()">ğŸ”“ è§£å¯†æ–‡ä»¶</button>
                    </div>
                </div>
                
                <!-- æ–‡æœ¬åŠ å¯†æ ‡ç­¾é¡µ -->
                <div id="text-encrypt-tab" class="tab-content">
                    <div id="text-alert"></div>
                    
                    <h2>ğŸ”’ åŠ å¯†æ–‡æœ¬</h2>
                    <div class="form-group">
                        <label>è¾“å…¥è¦åŠ å¯†çš„æ–‡æœ¬</label>
                        <textarea id="text-encrypt-input"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="encryptText()">ğŸ”’ åŠ å¯†æ–‡æœ¬</button>
                    
                    <div class="form-group">
                        <label>åŠ å¯†ç»“æœ</label>
                        <textarea id="text-encrypt-output" readonly style="font-family: monospace;"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="copyText('text-encrypt-output')">å¤åˆ¶ç»“æœ</button>
                    <button class="btn btn-secondary" onclick="clearTextEncrypt()">æ¸…ç©º</button>
                    
                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                    
                    <h2>ğŸ”“ è§£å¯†æ–‡æœ¬</h2>
                    <div class="form-group">
                        <label>è¾“å…¥è¦è§£å¯†çš„æ–‡æœ¬</label>
                        <textarea id="text-decrypt-input" style="font-family: monospace;"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="decryptText()">ğŸ”“ è§£å¯†æ–‡æœ¬</button>
                    
                    <div class="form-group">
                        <label>è§£å¯†ç»“æœ</label>
                        <textarea id="text-decrypt-output" readonly></textarea>
                    </div>
                    <button class="btn btn-success" onclick="copyText('text-decrypt-output')">å¤åˆ¶ç»“æœ</button>
                    <button class="btn btn-secondary" onclick="clearTextDecrypt()">æ¸…ç©º</button>
                </div>
                
                <!-- è®¾ç½®æ ‡ç­¾é¡µ -->
                <div id="settings-tab" class="tab-content">
                    <div id="settings-alert"></div>
                    
                    <h2>æ›´æ”¹ä¸»å¯†ç </h2>
                    <form id="change-password-form" onsubmit="return false;">
                        <div class="form-group">
                            <label>å½“å‰å¯†ç </label>
                            <input type="password" id="old-password" required>
                        </div>
                        
                        <div class="form-group">
                            <label>æ–°å¯†ç </label>
                            <input type="password" id="new-password1" required>
                        </div>
                        
                        <div class="form-group">
                            <label>ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" id="new-password2" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" onclick="changePassword()">ç¡®è®¤æ›´æ”¹</button>
                    </form>
                    
                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                    
                    <h2>å…³äº</h2>
                    <div class="info-box">
                        <strong>æ•°æ®åŠ å¯†ä¸å¯†ç ç®¡ç†ç³»ç»Ÿ v1.0</strong>
                        <ul>
                            <li>AES-256-GCM å†›äº‹çº§åŠ å¯†</li>
                            <li>Argon2 å¯†é’¥æ´¾ç”Ÿ</li>
                            <li>æœ¬åœ°å­˜å‚¨ï¼Œç»ä¸ä¸Šä¼ äº‘ç«¯</li>
                            <li>æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ vault/ ç›®å½•</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedPassword = null;
        
        // é¦–æ¬¡è®¾ç½®ä¸»å¯†ç 
        async function setupMasterPassword() {
            const password1 = document.getElementById('setup-password1').value;
            const password2 = document.getElementById('setup-password2').value;
            
            const response = await fetch('/api/setup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password1, password2})
            });
            
            const data = await response.json();
            showAlert('setup-alert', data.message, data.success ? 'success' : 'error');
            
            if (data.success) {
                setTimeout(() => {
                    document.getElementById('setup-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                    loadPasswords();
                }, 1000);
            }
        }
        
        // ç™»å½•
        async function login() {
            const password = document.getElementById('login-password').value;
            
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password})
            });
            
            const data = await response.json();
            showAlert('login-alert', data.message, data.success ? 'success' : 'error');
            
            if (data.success) {
                setTimeout(() => {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                    loadPasswords();
                }, 1000);
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                await fetch('/api/logout', {method: 'POST'});
                location.reload();
            }
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'passwords') {
                loadPasswords();
            }
        }
        
        // åŠ è½½å¯†ç åˆ—è¡¨
        async function loadPasswords() {
            const listDiv = document.getElementById('password-list');
            listDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            const response = await fetch('/api/passwords/list');
            const data = await response.json();
            
            if (data.success) {
                if (data.passwords.length === 0) {
                    listDiv.innerHTML = '<div class="loading">æš‚æ— å¯†ç </div>';
                } else {
                    listDiv.innerHTML = '';
                    data.passwords.forEach(site => {
                        const item = document.createElement('div');
                        item.className = 'password-item';
                        item.textContent = site;
                        item.onclick = () => selectPassword(site, item);
                        listDiv.appendChild(item);
                    });
                }
            } else {
                showAlert('password-alert', data.message, 'error');
            }
        }
        
        // é€‰æ‹©å¯†ç é¡¹
        function selectPassword(site, element) {
            document.querySelectorAll('.password-item').forEach(item => {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedPassword = site;
        }
        
        // æ·»åŠ å¯†ç 
        async function addPassword() {
            const site = document.getElementById('password-site').value;
            const username = document.getElementById('password-username').value;
            const password = document.getElementById('password-value').value;
            const notes = document.getElementById('password-notes').value;
            
            const response = await fetch('/api/passwords/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({site, username, password, notes})
            });
            
            const data = await response.json();
            showAlert('password-alert', data.message, data.success ? 'success' : 'error');
            
            if (data.success) {
                document.getElementById('add-password-form').reset();
                loadPasswords();
            }
        }
        
        // æŸ¥çœ‹å¯†ç 
        async function viewPassword() {
            if (!selectedPassword) {
                showAlert('password-alert', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯†ç é¡¹', 'error');
                return;
            }
            
            const response = await fetch(`/api/passwords/get/${encodeURIComponent(selectedPassword)}`);
            const data = await response.json();
            
            if (data.success) {
                const info = `ç½‘ç«™/æœåŠ¡: ${data.data.site}\nç”¨æˆ·å: ${data.data.username}\nå¯†ç : ${data.data.password}\n${data.data.notes ? 'å¤‡æ³¨: ' + data.data.notes : ''}`;
                alert(info);
            } else {
                showAlert('password-alert', data.message, 'error');
            }
        }
        
        // å¤åˆ¶å¯†ç 
        async function copyPassword() {
            if (!selectedPassword) {
                showAlert('password-alert', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯†ç é¡¹', 'error');
                return;
            }
            
            const response = await fetch(`/api/passwords/get/${encodeURIComponent(selectedPassword)}`);
            const data = await response.json();
            
            if (data.success) {
                navigator.clipboard.writeText(data.data.password);
                showAlert('password-alert', 'âœ… å¯†ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } else {
                showAlert('password-alert', data.message, 'error');
            }
        }
        
        // åˆ é™¤å¯†ç 
        async function deletePassword() {
            if (!selectedPassword) {
                showAlert('password-alert', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¯†ç é¡¹', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ '${selectedPassword}' çš„å¯†ç å—ï¼Ÿ`)) {
                return;
            }
            
            const response = await fetch(`/api/passwords/delete/${encodeURIComponent(selectedPassword)}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            showAlert('password-alert', data.message, data.success ? 'success' : 'error');
            
            if (data.success) {
                selectedPassword = null;
                loadPasswords();
            }
        }
        
        // ç”Ÿæˆå¼ºå¯†ç 
        async function generatePassword() {
            const length = document.getElementById('password-length').value;
            
            const response = await fetch('/api/passwords/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({length})
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('password-value').value = data.password;
                showAlert('password-alert', `å·²ç”Ÿæˆ${length}ä½å¼ºå¯†ç `, 'success');
            }
        }
        
        // åŠ å¯†æ–‡æœ¬
        async function encryptText() {
            const text = document.getElementById('text-encrypt-input').value;
            
            if (!text.trim()) {
                showAlert('text-alert', 'è¯·è¾“å…¥è¦åŠ å¯†çš„æ–‡æœ¬', 'error');
                return;
            }
            
            const response = await fetch('/api/text/encrypt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text})
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('text-encrypt-output').value = data.encrypted;
                showAlert('text-alert', 'âœ… æ–‡æœ¬åŠ å¯†æˆåŠŸ', 'success');
            } else {
                showAlert('text-alert', data.message, 'error');
            }
        }
        
        // è§£å¯†æ–‡æœ¬
        async function decryptText() {
            const text = document.getElementById('text-decrypt-input').value;
            
            if (!text.trim()) {
                showAlert('text-alert', 'è¯·è¾“å…¥è¦è§£å¯†çš„æ–‡æœ¬', 'error');
                return;
            }
            
            const response = await fetch('/api/text/decrypt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text})
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('text-decrypt-output').value = data.decrypted;
                showAlert('text-alert', 'âœ… æ–‡æœ¬è§£å¯†æˆåŠŸ', 'success');
            } else {
                showAlert('text-alert', data.message, 'error');
            }
        }
        
        // åˆ‡æ¢åŠ å¯†æ¨¡å¼
        function toggleEncryptMode() {
            const mode = document.querySelector('input[name="encrypt-mode"]:checked').value;
            
            if (mode === 'upload') {
                document.getElementById('upload-mode-section').classList.remove('hidden');
                document.getElementById('local-mode-section').classList.add('hidden');
            } else {
                document.getElementById('upload-mode-section').classList.add('hidden');
                document.getElementById('local-mode-section').classList.remove('hidden');
            }
        }
        
        // åŠ å¯†æ–‡ä»¶ï¼ˆä¸Šä¼ æ¨¡å¼ï¼‰
        async function encryptFile() {
            const fileInput = document.getElementById('encrypt-file-input');
            
            if (!fileInput.files[0]) {
                showAlert('file-alert', 'è¯·é€‰æ‹©è¦åŠ å¯†çš„æ–‡ä»¶', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            showAlert('file-alert', 'æ­£åœ¨åŠ å¯†æ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
            
            const response = await fetch('/api/file/encrypt', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('file-alert', `âœ… ${data.message}`, 'success');
                // è‡ªåŠ¨ä¸‹è½½åŠ å¯†åçš„æ–‡ä»¶
                window.location.href = data.download_url;
            } else {
                showAlert('file-alert', data.message, 'error');
            }
        }
        
        // è§£å¯†æ–‡ä»¶ï¼ˆä¸Šä¼ æ¨¡å¼ï¼‰
        async function decryptFile() {
            const fileInput = document.getElementById('decrypt-file-input');
            
            if (!fileInput.files[0]) {
                showAlert('file-alert', 'è¯·é€‰æ‹©è¦è§£å¯†çš„æ–‡ä»¶', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            showAlert('file-alert', 'æ­£åœ¨è§£å¯†æ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
            
            const response = await fetch('/api/file/decrypt', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('file-alert', `âœ… ${data.message}`, 'success');
                // è‡ªåŠ¨ä¸‹è½½è§£å¯†åçš„æ–‡ä»¶
                window.location.href = data.download_url;
            } else {
                showAlert('file-alert', data.message, 'error');
            }
        }
        
        // åŠ å¯†æœ¬åœ°æ–‡ä»¶
        async function encryptFileLocal() {
            const inputPath = document.getElementById('encrypt-local-path').value.trim();
            
            if (!inputPath) {
                showAlert('file-alert', 'è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„', 'error');
                return;
            }
            
            showAlert('file-alert', 'æ­£åœ¨åŠ å¯†æ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
            
            const response = await fetch('/api/file/encrypt-local', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({input_path: inputPath})
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('file-alert', `âœ… ${data.message}\nä¿å­˜ä½ç½®: ${data.output_path}`, 'success');
                document.getElementById('encrypt-local-path').value = '';
            } else {
                showAlert('file-alert', data.message, 'error');
            }
        }
        
        // è§£å¯†æœ¬åœ°æ–‡ä»¶
        async function decryptFileLocal() {
            const inputPath = document.getElementById('decrypt-local-path').value.trim();
            
            if (!inputPath) {
                showAlert('file-alert', 'è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„', 'error');
                return;
            }
            
            showAlert('file-alert', 'æ­£åœ¨è§£å¯†æ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
            
            const response = await fetch('/api/file/decrypt-local', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({input_path: inputPath})
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('file-alert', `âœ… ${data.message}\nä¿å­˜ä½ç½®: ${data.output_path}`, 'success');
                document.getElementById('decrypt-local-path').value = '';
            } else {
                showAlert('file-alert', data.message, 'error');
            }
        }
        
        // æ›´æ”¹ä¸»å¯†ç 
        async function changePassword() {
            const oldPassword = document.getElementById('old-password').value;
            const newPassword1 = document.getElementById('new-password1').value;
            const newPassword2 = document.getElementById('new-password2').value;
            
            const response = await fetch('/api/change-password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({old_password: oldPassword, new_password1: newPassword1, new_password2: newPassword2})
            });
            
            const data = await response.json();
            showAlert('settings-alert', data.message, data.success ? 'success' : 'error');
            
            if (data.success) {
                document.getElementById('change-password-form').reset();
            }
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶å
        function displayFilename(type) {
            const input = document.getElementById(type + '-file-input');
            const display = document.getElementById(type + '-filename');
            
            if (input.files[0]) {
                display.textContent = input.files[0].name;
            } else {
                display.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            }
        }
        
        // å¤åˆ¶æ–‡æœ¬
        function copyText(elementId) {
            const text = document.getElementById(elementId).value;
            
            if (text) {
                navigator.clipboard.writeText(text);
                showAlert('text-alert', 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } else {
                showAlert('text-alert', 'æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'error');
            }
        }
        
        // æ¸…ç©ºæ–‡æœ¬åŠ å¯†
        function clearTextEncrypt() {
            document.getElementById('text-encrypt-input').value = '';
            document.getElementById('text-encrypt-output').value = '';
        }
        
        // æ¸…ç©ºæ–‡æœ¬è§£å¯†
        function clearTextDecrypt() {
            document.getElementById('text-decrypt-input').value = '';
            document.getElementById('text-decrypt-output').value = '';
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // å¦‚æœå·²ç™»å½•ï¼ŒåŠ è½½å¯†ç åˆ—è¡¨
            if (!document.getElementById('main-screen').classList.contains('hidden')) {
                loadPasswords();
            }
            
            // å›è½¦ç™»å½•
            document.getElementById('login-password')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // å›è½¦è®¾ç½®å¯†ç 
            document.getElementById('setup-password2')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    setupMasterPassword();
                }
            });
        });
    </script>
</body>
</html>
